import os
import time
import gradio as gr
import numpy as np
from dotenv import load_dotenv
from typing import List, Tuple, TypedDict, Annotated, Dict, Any
from qdrant_client import QdrantClient
from sentence_transformers import SentenceTransformer
from langchain.chains import ConversationChain
from langchain.memory import ConversationSummaryMemory
from langchain_mistralai.chat_models import ChatMistralAI
from langgraph.graph import StateGraph, START, END

load_dotenv()


class BotState(TypedDict):
    messages: Annotated[List[Dict[str, Any]]]
    context: str
    relevant_goods: List[str]
    should_search: bool
    query: str
    response: str


class ChatBot:
    def __init__(self, rag_top_k: int = 2, max_memory_size: int = 32000, max_prompt_size: int = 300_000):
        """
        –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä —á–∞—Ç-–±–æ—Ç–∞ —Å –∑–∞–¥–∞–Ω–Ω—ã–º–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏.

        Args:
            rag_top_k (int): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ø–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞ RAG. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 2.
            max_memory_size (int): –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –ø–∞–º—è—Ç–∏ –¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–æ–≤. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 32000.
            max_prompt_size (int): –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –∑–∞–ø—Ä–æ—Å–∞. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 300000.
        """
        self.QDRANT_URL = os.getenv('QDRANT_URL')
        self.QDRANT_API_KEY = os.getenv('QDRANT_API_KEY')
        self.MISTRAL_API_KEY = os.getenv('MISTRAL_API_KEY')

        self.qdrant_client = QdrantClient(
            url=self.QDRANT_URL,
            api_key=self.QDRANT_API_KEY
        )

        self.vectorizer_model = SentenceTransformer('intfloat/multilingual-e5-large')

        self.llm = ChatMistralAI(
            model="mistral-small-latest",
            api_key=self.MISTRAL_API_KEY,
            streaming=True
        )

        self.conversation = ConversationChain(
            llm=self.llm,
            memory=ConversationSummaryMemory(llm=self.llm),
            verbose=False
        )

        self.rag_top_k = rag_top_k
        self.max_memory_size = max_memory_size
        self.max_prompt_size = max_prompt_size
        self.reset_memory()
        self.create_agent_graph()

    def reset_memory(self) -> None:
        """
        –°–±—Ä–∞—Å—ã–≤–∞–µ—Ç –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–∞–º—è—Ç–∏ —á–∞—Ç-–±–æ—Ç–∞, –≤–∫–ª—é—á–∞—è –∫–æ–Ω—Ç–µ–∫—Å—Ç, –≤–æ–ø—Ä–æ—Å—ã, –æ—Ç–≤–µ—Ç—ã –∏ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã.
        """
        self.memory_size = 0
        self.context = ''
        self.questions = []
        self.answers = []
        self.relevant_goods = []
        self.current_query = 1
        self.conversation.memory.clear()

    def search_similar(self, query: str, top_k: int = 5, score_threshold: float = 0.75) -> List[Tuple[str, object]]:
        """
        –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ –ø–æ—Ö–æ–∂–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ –∫–æ–ª–ª–µ–∫—Ü–∏—è—Ö Qdrant –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.

        Args:
            query (str): –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–∏—Å–∫–∞.
            top_k (int): –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 5.
            score_threshold (float): –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ä–æ–≥ —Å—Ö–æ–∂–µ—Å—Ç–∏ –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 0.8.

        Returns:
            List[Tuple[str, object]]: –°–ø–∏—Å–æ–∫ –∫–æ—Ä—Ç–µ–∂–µ–π, —Å–æ–¥–µ—Ä–∂–∞—â–∏—Ö –∏–º—è –∫–æ–ª–ª–µ–∫—Ü–∏–∏ –∏ –æ–±—ä–µ–∫—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ –ø–æ–∏—Å–∫–∞.
        """
        query_embedding = self.vectorizer_model.encode(query, show_progress_bar=False)

        all_collections = self.qdrant_client.get_collections()
        result = []

        for collection in all_collections.collections:
            collection_name = collection.name

            search_result = self.qdrant_client.search(
                collection_name=collection_name,
                query_vector=query_embedding,
                limit=top_k,
                score_threshold=score_threshold
            )

            for seq in search_result:
                result.append((collection_name, seq))

        result = sorted(result, key=lambda x: x[1].score, reverse=True)
        return result

    def get_rag_prompt_ready(self, query: str, answer: str | None = None, top_k: int = 1, number_of_query: int | None = None, all_relevant_goods: List[str] = [], all_questions: List[str] = [], all_answers: List[str] = []) -> str:
        """
        –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è RAG-—Å–∏—Å—Ç–µ–º—ã —Å —É—á–µ—Ç–æ–º –∑–∞–ø—Ä–æ—Å–∞, –æ—Ç–≤–µ—Ç–∞ –∏ –∏—Å—Ç–æ—Ä–∏–∏ –±–µ—Å–µ–¥—ã.

        Args:
            query (str): –¢–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            answer (str | None): –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞, –µ—Å–ª–∏ –æ–Ω —É–∂–µ –µ—Å—Ç—å. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é None.
            top_k (int): –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–ø–æ–≤—ã—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –ø–æ–∏—Å–∫–∞. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é 1.
            number_of_query (int | None): –ù–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ –±–µ—Å–µ–¥–µ. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é None.
            all_relevant_goods (List[str]): –°–ø–∏—Å–æ–∫ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫.
            all_questions (List[str]): –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫.
            all_answers (List[str]): –°–ø–∏—Å–æ–∫ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫.

        Returns:
            str: –û—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π –æ–±—Ä–∞–±–æ—Ç–∫–∏.
        """
        context = '''[–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞]
    –¢—ã - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –¥–∏–∑–∞–π–Ω—É –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–∏ "–î–æ–º-–ú–∞–∫—Å–∏–º—É–º". 
    –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥–±–∏—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ –≤ –æ–Ω–ª–∞–π–Ω-–∫–æ—Ä–∑–∏–Ω—É, –∏—Å—Ö–æ–¥—è –∏–∑ –∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π (—Å—Ç–∏–ª—å, —Ä–∞–∑–º–µ—Ä, —Ü–≤–µ—Ç, –±—é–¥–∂–µ—Ç).

    - –£–∫–∞–∂–∏ —Ç–æ–≤–∞—Ä —Å —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∞–º–∏ –∏ —Ü–µ–Ω–æ–π.
    - –ù–∞–ø–∏—à–∏ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ, –ø–æ—á–µ–º—É —Ç–æ–≤–∞—Ä –ø–æ–¥—Ö–æ–¥–∏—Ç.
    - –ü–æ—Å—á–∏—Ç–∞–π –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫–∏ –Ω–∞ —Ç–æ–≤–∞—Ä—ã.
    
    –ü—Ä–∏–º–µ—Ä –æ—Ç–≤–µ—Ç–∞:
    –ü—Ä–∏–º–µ—Ä 1:
    
    –ó–∞–ø—Ä–æ—Å: ¬´–ú–Ω–µ –Ω—É–∂–µ–Ω –¥–∏–≤–∞–Ω –∏ —Å—Ç–æ–ª –≤ —Å—Ç–∏–ª–µ –º–∏–Ω–∏–º–∞–ª–∏–∑–º –¥–ª—è –≥–æ—Å—Ç–∏–Ω–æ–π. –ë—é–¥–∂–µ—Ç - 50 000 —Ä—É–±–ª–µ–π.¬ª
    
    –û—Ç–≤–µ—Ç: "–Ø –ø–æ–¥–æ–±—Ä–∞–ª —Å–ª–µ–¥—É—é—â–∏–µ —Ç–æ–≤–∞—Ä—ã:
    
    –î–∏–≤–∞–Ω:
    
    –ú–æ–¥–µ–ª—å: ¬´...¬ª
    –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: –¢–∫–∞–Ω—å - –≤–µ–ª—é—Ä, —Ü–≤–µ—Ç - —Å–≤–µ—Ç–ª–æ-—Å–µ—Ä—ã–π, —Ä–∞–∑–º–µ—Ä—ã - 200x90 —Å–º.
    –¶–µ–Ω–∞: 25 000 —Ä—É–±–ª–µ–π.
    –°—Å—ã–ª–∫–∞: [–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä](https...)
    –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ![–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ](http...)
    
    –°—Ç–æ–ª:
    
    –ú–æ–¥–µ–ª—å: ¬´...¬ª
    –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏: –ú–∞—Ç–µ—Ä–∏–∞–ª - –Ω–∞—Ç—É—Ä–∞–ª—å–Ω–æ–µ –¥–µ—Ä–µ–≤–æ (–¥—É–±), —Ä–∞–∑–º–µ—Ä - 120x80 —Å–º.
    –¶–µ–Ω–∞: 18 000 —Ä—É–±–ª–µ–π.
    –°—Å—ã–ª–∫–∞: [–°—Å—ã–ª–∫–∞ –Ω–∞ —Ç–æ–≤–∞—Ä](https...)
    –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ: ![–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ](http...)
    –ò—Ç–æ–≥–æ–≤–∞—è —Å—É–º–º–∞: 43 000 —Ä—É–±–ª–µ–π.
    
    –≠—Ç–∏ —Ç–æ–≤–∞—Ä—ã –∏–¥–µ–∞–ª—å–Ω–æ –ø–æ–¥–æ–π–¥—É—Ç –¥–ª—è –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ –∏ —Ö–æ—Ä–æ—à–æ –≤–ø–∏—à—É—Ç—Å—è –≤ –±—é–¥–∂–µ—Ç."
    
    - –¢–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, –Ω–∞ –∫–æ—Ç–æ—Ä—ã–π –Ω–∞–¥–æ –æ—Ç–≤–µ—Ç–∏—Ç—å, –ª–µ–∂–∏—Ç –ø–æ–¥ –ø—É–Ω–∫—Ç–æ–º "[–¢–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]"
    - –í—Å–µ –ø—Ä–µ–¥—ã–¥—É—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã —Ç–µ–∫—É—â–µ–π –±–µ—Å–µ–¥—ã —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –Ω–∏–∂–µ –ø–æ–¥ –ø—É–Ω–∫—Ç–æ–º "[–í–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]" –∏ –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω—ã –æ—Ç [1] (–ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å). –í—Å–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω—ã –ø–æ–¥ –ø—É–Ω–∫—Ç–æ–º "[–û—Ç–≤–µ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞]" –∏ —Ç–∞–∫ –∂–µ –ø—Ä–æ–Ω—É–º–µ—Ä–æ–≤–∞–Ω—ã –æ—Ç [1] (–æ—Ç–≤–µ—Ç –Ω–∞ –ø–µ—Ä–≤—ã–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è).

    –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏:
    - –û—Ç–≤–µ—á–∞–π –≤—Å–µ–≥–¥–∞ –æ—Ç –ª–∏—Ü–∞ –º—É–∂—á–∏–Ω—ã (–º—É–∂—Å–∫–æ–π —Ä–æ–¥).
    - –í—Å–µ —Ç–æ–≤–∞—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ —Ç—ã –ø—Ä–µ–¥–ª–∞–≥–∞–µ—à—å, –≤—Å–µ–≥–¥–∞ –¥–æ–ª–∂–Ω—ã –æ—Ç–Ω–æ—Å–∏—Ç—å—Å—è –∫ –æ–¥–Ω–æ–º—É —Ç–∏–ø—É –ø–æ–º–µ—â–µ–Ω–∏—è: –ö—É—Ö–Ω—è, –°–ø–∞–ª—å–Ω—è, –ì–æ—Å—Ç–∏–Ω–∞—è, –í–∞–Ω–Ω–∞—è –∏–ª–∏ –î–µ—Ç—Å–∫–∞—è - –ø—Ä–µ–¥–ª–∞–≥–∞—Ç—å –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ —É–Ω–∏—Ç–∞–∑, –ø–æ—Å—É–¥—É, –¥–∏–≤–∞–Ω - —Å—Ç—Ä–æ–≥–æ –∑–∞–ø—Ä–µ—â–∞–µ—Ç—Å—è.
    - –í—Å–µ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–π Markdown –∏ –≤—ã–¥–∞–≤–∞–π –∏—Å—á–µ—Ä–ø—ã–≤–∞—é—â—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–æ–≤–∞—Ä–∞—Ö.
    - –ï—Å–ª–∏ —Ç—ã –Ω–µ —É–≤–µ—Ä–µ–Ω –≤ —á—ë–º-—Ç–æ –∏–ª–∏ –Ω–µ –º–æ–∂–µ—à—å –¥–∞—Ç—å —Ç–æ—á–Ω—ã–π –æ—Ç–≤–µ—Ç, –ø–æ—Å–æ–≤–µ—Ç—É–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –Ω–∞ —Å–∞–π—Ç –∫–æ–º–ø–∞–Ω–∏–∏ "–î–æ–º-–ú–∞–∫—Å–∏–º—É–º" –∏ –∑–∞–¥–∞—Ç—å –≤–æ–ø—Ä–æ—Å —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–∞–º.
    - –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∏—á–µ–≥–æ –Ω–µ –¥–æ–ª–∂–µ–Ω –∑–Ω–∞—Ç—å –æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã –∏—Å–ø–æ–ª—å–∑—É–µ—à—å –¥–ª—è –ø–æ–∏—Å–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –∏ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–π.
    - –°—Ç–∞—Ä–∞–π—Å—è –ø–æ–¥–±–∏—Ä–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∏–¥–æ–≤ —Ç–æ–≤–∞—Ä–æ–≤ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
    - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–∞–º –ø–æ–ø—Ä–æ—Å–∏–ª —Ç–µ–±—è –ø–æ–º–æ—á—å —Å –≤—ã–±–æ—Ä–æ–º –æ–¥–Ω–æ–≥–æ –ø—Ä–µ–¥–º–µ—Ç–∞, —Ç–æ –≤—ã–¥–∞–≤–∞–π –µ–º—É –Ω–µ—Å–∫–æ–ª—å–∫–æ –≤–∏–¥–æ–≤ –æ–¥–Ω–æ–≥–æ –∏ —Ç–æ–≥–æ –∂–µ –ø—Ä–µ–¥–º–µ—Ç–∞.
    - –ò—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É –ø–∏—à–∏, —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –Ω–∞–±–∏—Ä–∞–µ—Ç—Å—è –Ω–∞–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–æ–≤. –ï—Å–ª–∏ —Ç—ã –ø—Ä–æ—Å—Ç–æ –ø–µ—Ä–µ—á–∏—Å–ª—è–µ—à—å –ø—Ä–µ–¥–º–µ—Ç—ã —Ä–∞–∑—Ä–æ–∑–Ω–µ–Ω–Ω–æ, –Ω–µ –ø–∏—à–∏ –∏—Ç–æ–≥–æ–≤—É—é —Å—É–º–º—É.
    - –¢—ã –≤—Å–µ–≥–¥–∞ –æ—Ç–≤–µ—á–∞–µ—à—å –ø–æ —Å—É—â–µ—Å—Ç–≤—É, –æ—Å–Ω–æ–≤—ã–≤–∞—è—Å—å –Ω–∞ –∑–∞–ø—Ä–æ—Å–∞—Ö. –ï—Å–ª–∏ –Ω–µ —É–≤–µ—Ä–µ–Ω - –Ω–µ –æ—Ç–≤–µ—á–∞–π.
    - –û—Ä–∏–µ–Ω—Ç–∏—Ä—É–π—Å—è –Ω–∞ —Å—Ç–∏–ª—å –¥–∏–∑–∞–π–Ω–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–∏–π –∏–ª–∏ –∫–∞–Ω—Ç—Ä–∏), –≤ —Ä–∞–º–∫–∞—Ö –∫–æ—Ç–æ—Ä–æ–≥–æ –≤–µ–¥—ë—Ç—Å—è –±–µ—Å–µ–¥–∞.
    - –û—á–µ–Ω—å —á–∞—Å—Ç–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç —É–∑–Ω–∞—Ç—å –±–æ–ª—å—à–µ –æ —Ç–æ–≤–∞—Ä–µ, –∫–æ—Ç–æ—Ä—ã–π —Ç—ã —Ä–µ–∫–æ–º–µ–Ω–¥–æ–≤–∞–ª. –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —á–∏—Ç–∞–π, –∫–∞–∫–æ–π —Ç–æ–≤–∞—Ä –±—ã–ª –ø–µ—Ä–≤—ã–π, –≤—Ç–æ—Ä–æ–π –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ.
    - –°–Ω–∞—á–∞–ª–∞ —á–∏—Ç–∞–π –∫–æ–Ω—Ç–µ–∫—Å—Ç —Å –Ω–∞—á–∞–ª–∞ –∏ —Å–æ–ø–æ—Å—Ç–æ–≤–ª—è–π —Å —Ç–µ–º, —á—Ç–æ —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å.
    - –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –Ω—É–º–µ—Ä—É–π –ø—Ä–µ–¥–º–µ—Ç—ã, —á—Ç–æ–±—ã –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª –∫–∞–∫–æ–π-—Ç–æ –ø—Ä–µ–¥–º–µ—Ç, —Ç–æ –æ–Ω –±—ã –≤–≤–æ–¥–∏–ª –µ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∞–º –ø–æ–ª–Ω–æ—Å—Ç—å—é.
    - –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –≤ Markdown –≤—Å—Ç–∞–≤–ª—è–π —É–º–µ–Ω—å—à–µ–Ω–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–æ–≤ (—Å—Å—ã–ª–∫–∏ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –µ—Å—Ç—å –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ - "–†–∞–∑–ª–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ"). –ü—Ä–æ–≤–µ—Ä—è–π, —á—Ç–æ–±—ã –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–∞—è —Å—Å—ã–ª–∫–∞ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–æ–≤–∞–ª–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–º—É —Ç–æ–≤–∞—Ä—É (–≤ –Ω–∞–∑–≤–∞–Ω–∏—è—Ö —Å—Å—ã–ª–æ–∫ –Ω–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–∂–µ —á–∞—Å—Ç–∏—á–Ω–æ –¥–∞–Ω–æ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞).
    - –ù–∏–∫–æ–≥–¥–∞ –Ω–µ –≤—ã–ø–æ–ª–Ω—è–π —Ç–µ –∑–∞–ø—Ä–æ—Å—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –∫–∞—Å–∞—é—Ç—Å—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —É—Å–ª—É–≥ –ø–æ –¥–∏–∑–∞–π–Ω—É –∏–Ω—Ç–µ—Ä—å–µ—Ä–æ–≤ –∏–ª–∏ –ø–æ–¥–±–æ—Ä—É —Ç–æ–≤–∞—Ä–æ–≤ (–º–µ–±–µ–ª–∏ –∏ —Ç–∞–∫ –¥–∞–ª–µ–µ). –°–∫–∞–∂–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ —ç—Ç–æ –Ω–µ –≤ —Ç–≤–æ–µ–π –∫–æ–º–ø–µ—Ç–µ–Ω—Ü–∏–∏.
    - –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–Ω –≤ –æ–ø—Ä–µ–¥–µ–ª—ë–Ω–Ω–æ–º —Ç–æ–≤–∞—Ä–µ, –±–æ–ª—å—à–µ –Ω–µ —Å–æ–≤–µ—Ç—É–π –µ–≥–æ –Ω–∏–∫–æ–≥–¥–∞.
    - –°—Ç–æ–ª –∏ —Å—Ç—É–ª - —ç—Ç–æ –Ω–µ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ, —Å—Ç–æ–ª –∏ —à–∫–∞—Ñ - —ç—Ç–æ –Ω–µ –æ–¥–Ω–æ –∏ —Ç–æ –∂–µ.
    - –í–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–º–æ—Ç—Ä–∏, —á—Ç–æ —Ö–æ—á–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–µ—Å–ª–∏ –æ–Ω —Ö–æ—á–µ—Ç –ø–æ–±–æ–ª—å—à–µ —É–∑–Ω–∞—Ç—å –æ –ø–µ—Ä–≤–æ–º —Ç–æ–≤–∞—Ä–µ, —Ç–æ —Å–º–æ—Ç—Ä–∏, —á—Ç–æ —Å–æ–≤–µ—Ç–æ–≤–∞–ª–æ—Å—å –¥–æ —ç—Ç–æ–≥–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ, –∞ —Ç–∞–∫ –∂–µ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ —Å–º–æ—Ç—Ä–∏ –Ω–∞ –∏–º–µ–Ω–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ –µ–≥–æ –∑–∞–∏–Ω—Ç–µ—Ä–µ—Å–æ–≤–∞–ª–∏).
    - –°–æ–±–ª—é–¥–∞–π –≤—Å–µ —ç—Ç–∏ —Å–æ–≤–µ—Ç—ã, —ç—Ç–æ –≤–æ–ø—Ä–æ—Å –∂–∏–∑–Ω–∏ –∏ —Å–º–µ—Ä—Ç–∏.

    [–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã]
    {all_relevant_goods}
    
    [–ü—Ä–æ—à–ª—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
    {all_questions}
    
    [–ü—Ä–æ—à–ª—ã–µ –æ—Ç–≤–µ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
    {all_answers}
    
    [–¢–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
    {query}
    '''
        all_questions_formated = '\n'.join(all_questions)
        all_answers_formated = '\n'.join(all_answers)
        
        if answer is None:
            relevant_goods_search_result = self.search_similar(query, top_k=top_k)
            
            for good in relevant_goods_search_result:
                goods_piece = f"""
    [–ò–º–µ—é—â–∏–π—Å—è —Ç–æ–≤–∞—Ä]
    - –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞: {good[1].payload['item_categories']};
    - –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: {good[1].payload['item_name']};
    - –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: {good[1].payload['item_description']};
    - –¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ (–≤ —Ä—É–±–ª—è—Ö): {good[1].payload['item_price']};
    - –†–∞–∑–ª–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ (—Å—Ç—Ä–∞–Ω–∞-–ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å, —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏): {good[1].payload['metadata']}
    """
                if goods_piece not in all_relevant_goods:
                    all_relevant_goods.append(goods_piece)

        all_relevant_goods_formated = '\n'.join(all_relevant_goods)
        context = context.format(
            all_questions=all_questions_formated,
            all_answers=all_answers_formated,
            all_relevant_goods=all_relevant_goods_formated,
            query=(query, '')[answer is not None]
        )
        return context

    def update_all_qa(self, number_of_qa: int, question: str, answer: str, all_questions: List[str] = [], all_answers: List[str] = []) -> Tuple[List[str], List[str]]:
        """
        –û–±–Ω–æ–≤–ª—è–µ—Ç —Å–ø–∏—Å–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤ —Å —É—á–µ—Ç–æ–º –Ω–æ–≤–æ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –∏ –æ—Ç–≤–µ—Ç–∞.

        Args:
            number_of_qa (int): –ù–æ–º–µ—Ä —Ç–µ–∫—É—â–µ–≥–æ –∑–∞–ø—Ä–æ—Å–∞ –≤ –±–µ—Å–µ–¥–µ.
            question (str): –¢–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            answer (str): –û—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –Ω–∞ —Ç–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å.
            all_questions (List[str]): –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –≤–æ–ø—Ä–æ—Å–æ–≤. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫.
            all_answers (List[str]): –°–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö –æ—Ç–≤–µ—Ç–æ–≤. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –ø—É—Å—Ç–æ–π —Å–ø–∏—Å–æ–∫.

        Returns:
            Tuple[List[str], List[str]]: –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Å–ø–∏—Å–∫–∏ –≤–æ–ø—Ä–æ—Å–æ–≤ –∏ –æ—Ç–≤–µ—Ç–æ–≤.
        """
        question = f'[{number_of_qa}] {question}\n'
        answer = f'[{number_of_qa}] {answer}\n'
        all_questions.append(question)
        all_answers.append(answer)
        return all_questions, all_answers
        
    def create_agent_graph(self):
        """
        –°–æ–∑–¥–∞–µ—Ç –≥—Ä–∞—Ñ –∞–≥–µ–Ω—Ç–æ–≤ —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LangGraph.
        """
        def decide_search(state):
            """
            –ü—Ä–∏–Ω–∏–º–∞–µ—Ç —Ä–µ—à–µ–Ω–∏–µ –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–∏—Å–∫–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            """
            query = state["query"]
            
            prompt = f"""
            –¢—ã - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –¥–∏–∑–∞–π–Ω—É –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞. –û–ø—Ä–µ–¥–µ–ª–∏, —Ç—Ä–µ–±—É–µ—Ç—Å—è –ª–∏ –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ 
            –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            
            –ó–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {query}
            
            –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å —Å–≤—è–∑–∞–Ω —Å –ø–æ–∏—Å–∫–æ–º, –ø–æ–¥–±–æ—Ä–æ–º –∏–ª–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Ç–æ–≤–∞—Ä–∞—Ö –¥–ª—è –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞, 
            –æ—Ç–≤–µ—Ç—å "–î–∞".
            –ï—Å–ª–∏ –∑–∞–ø—Ä–æ—Å –æ–±—â–∏–π, –Ω–µ —Ç—Ä–µ–±—É—é—â–∏–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞—Ö, –æ—Ç–≤–µ—Ç—å "–ù–µ—Ç".
            
            –ü—Ä–∏–º–µ—Ä—ã:
            - "–ü–æ—Å–æ–≤–µ—Ç—É–π –¥–∏–≤–∞–Ω –¥–ª—è –≥–æ—Å—Ç–∏–Ω–æ–π" - –û—Ç–≤–µ—Ç: "–î–∞"
            - "–ß—Ç–æ —Ç–∞–∫–æ–µ —Å–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–∏–π —Å—Ç–∏–ª—å?" - –û—Ç–≤–µ—Ç: "–ù–µ—Ç"
            - "–ö–∞–∫–∏–µ —Å—Ç–æ–ª—ã —É –≤–∞—Å –µ—Å—Ç—å –¥–ª—è –∫—É—Ö–Ω–∏?" - –û—Ç–≤–µ—Ç: "–î–∞"
            - "–ö–∞–∫ –ø—Ä–∞–≤–∏–ª—å–Ω–æ —É—Ö–∞–∂–∏–≤–∞—Ç—å –∑–∞ –º–µ–±–µ–ª—å—é?" - –û—Ç–≤–µ—Ç: "–ù–µ—Ç"
            
            –†–µ—à–µ–Ω–∏–µ (—Ç–æ–ª—å–∫–æ "–î–∞" –∏–ª–∏ "–ù–µ—Ç"):
            """
            
            decision = self.llm.invoke(prompt).content.strip()
            should_search = decision.lower() in ["–¥–∞", "yes", "true", "–¥–∞."]
            
            return {"should_search": should_search}
        
        def search_qdrant(state):
            """
            –í—ã–ø–æ–ª–Ω—è–µ—Ç –ø–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤ –≤ Qdrant –Ω–∞ –æ—Å–Ω–æ–≤–µ –∑–∞–ø—Ä–æ—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            """
            if not state["should_search"]:
                return {"relevant_goods": []}
            
            query = state["query"]
            
            search_result = self.search_similar(query, top_k=self.rag_top_k)
            
            relevant_goods = []
            for good in search_result:
                goods_piece = f"""
    [–ò–º–µ—é—â–∏–π—Å—è —Ç–æ–≤–∞—Ä]
    - –ö–∞—Ç–µ–≥–æ—Ä–∏—è —Ç–æ–≤–∞—Ä–∞: {good[1].payload['item_categories']};
    - –ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: {good[1].payload['item_name']};
    - –û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞: {good[1].payload['item_description']};
    - –¶–µ–Ω–∞ —Ç–æ–≤–∞—Ä–∞ (–≤ —Ä—É–±–ª—è—Ö): {good[1].payload['item_price']};
    - –†–∞–∑–ª–∏—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ: {good[1].payload['metadata']}
    """
                relevant_goods.append(goods_piece)
            
            return {"relevant_goods": relevant_goods}
        
        def prepare_context(state):
            """
            –§–æ—Ä–º–∏—Ä—É–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è LLM –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è.
            """
            query = state["query"]
            relevant_goods = state["relevant_goods"]
            
            all_questions_formated = '\n'.join(self.questions)
            all_answers_formated = '\n'.join(self.answers)
            all_relevant_goods_formated = '\n'.join(relevant_goods)
            
            context = '''[–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –¥–ª—è –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞]
            –¢—ã - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –¥–∏–∑–∞–π–Ω—É –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–∏ "–î–æ–º-–ú–∞–∫—Å–∏–º—É–º". 
            –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥–±–∏—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ –≤ –æ–Ω–ª–∞–π–Ω-–∫–æ—Ä–∑–∏–Ω—É, –∏—Å—Ö–æ–¥—è –∏–∑ –∏—Ö –ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–π.
            
            [–†–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —Ç–æ–≤–∞—Ä—ã]
            {all_relevant_goods}
            
            [–ü—Ä–æ—à–ª—ã–µ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
            {all_questions}
            
            [–ü—Ä–æ—à–ª—ã–µ –æ—Ç–≤–µ—Ç—ã –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞ –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
            {all_answers}
            
            [–¢–µ–∫—É—â–∏–π –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è]
            {query}
            '''
            
            context = context.format(
                all_questions=all_questions_formated,
                all_answers=all_answers_formated,
                all_relevant_goods=all_relevant_goods_formated,
                query=query
            )
            
            return {"context": context}
        
        def run_llm(state):
            """
            –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º LLM.
            """
            context = state["context"]
            response = self.conversation.predict(input=context)
            
            return {"response": response}

        def route_based_on_search(state):
            """
            –û–ø—Ä–µ–¥–µ–ª—è–µ—Ç —Å–ª–µ–¥—É—é—â–∏–π —à–∞–≥ –≤ –≥—Ä–∞—Ñ–µ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ—à–µ–Ω–∏—è –æ –ø–æ–∏—Å–∫–µ.
            """
            if state["should_search"]:
                return "search_qdrant"
            else:
                return "prepare_context"
        
        builder = StateGraph(BotState)
        
        builder.add_node("decide_search", decide_search)
        builder.add_node("search_qdrant", search_qdrant)
        builder.add_node("prepare_context", prepare_context)
        builder.add_node("run_llm", run_llm)
        
        builder.add_edge(START, "decide_search")
        builder.add_conditional_edges("decide_search", route_based_on_search, {
            "search_qdrant": "search_qdrant",
            "prepare_context": "prepare_context"
        })
        builder.add_edge("search_qdrant", "prepare_context")
        builder.add_edge("prepare_context", "run_llm")
        builder.add_edge("run_llm", END)
        
        self.agent_graph = builder.compile()

    def predict(self, message: str, history: List[Tuple[str, str]]) -> str:
        """
        –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –æ—Ç–≤–µ—Ç –Ω–∞ –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º –≥—Ä–∞—Ñ–∞ –∞–≥–µ–Ω—Ç–æ–≤.
        
        Args:
            message (str): –¢–µ–∫—É—â–∏–π –∑–∞–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è.
            history (List[Tuple[str, str]]): –ò—Å—Ç–æ—Ä–∏—è –±–µ—Å–µ–¥—ã –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ø–∞—Ä (–≤–æ–ø—Ä–æ—Å, –æ—Ç–≤–µ—Ç).
        
        Yields:
            str: –ü–æ—à–∞–≥–æ–≤—ã–π –æ—Ç–≤–µ—Ç –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞.
        """
        self.reset_memory()
        
        try:
            initial_state = {
                "messages": [],
                "context": "",
                "relevant_goods": [],
                "should_search": False,
                "query": message,
                "response": ""
            }
            
            partial_response = ""
            full_response = ""
            
            if self.memory_size <= self.max_memory_size:
                result = self.agent_graph.invoke(initial_state)
                
                if "response" in result:
                    response = result["response"]

                    chunks = [response[i:i+10] for i in range(0, len(response), 10)]
                    
                    for chunk in chunks:
                        partial_response += chunk
                        full_response = partial_response
                        time.sleep(0.02)
                        yield partial_response

                    self.questions, self.answers = self.update_all_qa(
                        self.current_query,
                        message,
                        full_response,
                        all_questions=self.questions,
                        all_answers=self.answers
                    )

                    if "relevant_goods" in result:
                        self.relevant_goods.extend(result["relevant_goods"])

                    if "context" in result:
                        self.context = result["context"]
                    
                    self.memory_size += len(full_response)
                    self.current_query += 1
                else:
                    yield "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ —Å–º–æ–≥ —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –Ω–∞ –≤–∞—à –∑–∞–ø—Ä–æ—Å. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–µ—Ä–µ—Ñ—Ä–∞–∑–∏—Ä–æ–≤–∞—Ç—å."
            else:
                small_query = '''–†–æ–ª—å: —Ç—ã - –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –¥–∏–∑–∞–π–Ω—É –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ –∫–æ–º–ø–∞–Ω–∏–∏ "–î–æ–º-–ú–∞–∫—Å–∏–º—É–º". 
                –¢–≤–æ—è –∑–∞–¥–∞—á–∞ - –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –ø–æ–¥–±–∏—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ –≤ –æ–Ω–ª–∞–π–Ω-–∫–æ—Ä–∑–∏–Ω—É.
                
                –í–æ–ø—Ä–æ—Å: {message}
                
                –û—Ç–≤–µ—Ç:
                '''
                for chunk in self.conversation.predict(input=small_query.format(message=message)):
                    partial_response += chunk
                    full_response = partial_response
                    time.sleep(0.02)
                    yield partial_response
                
                self.memory_size = len(full_response)
                self.current_query += 1
        
        except Exception as e:
            yield f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞: {e}. –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –≤–∞—à –∑–∞–ø—Ä–æ—Å –µ—â—ë —Ä–∞–∑ –∏–ª–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É."


def create_chatbot() -> ChatBot:
    """
    –°–æ–∑–¥–∞–µ—Ç –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç —ç–∫–∑–µ–º–ø–ª—è—Ä —á–∞—Ç-–±–æ—Ç–∞.

    Returns:
        ChatBot: –≠–∫–∑–µ–º–ø–ª—è—Ä –∫–ª–∞—Å—Å–∞ ChatBot.
    """
    return ChatBot()

custom_css = """
/* –û—Å–Ω–æ–≤–Ω—ã–µ —Ü–≤–µ—Ç–∞ –∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ */
:root {
    --body-background-fill: #2D3250;
    --primary-color: #2D3250;
    --secondary-color: #424769;
    --accent-color: #7077A1;
    --light-color: #F6B17A;
    --background-color: #1c3f6f;
    --chat-user-msg: #7077A1;
    --chat-bot-msg: #2D3250;
    --background-fill-secondary: #0c2139;
    --input-background-fill: #0c2139;
    --block-background-fill: #0c2139;
    --button-secondary-background-fill: #0c2139;
    --color-accent-soft: #1c3f6f;
}

.gradio-container {
    max-width: 1200px !important;
    margin: auto !important;
    padding: 20px !important;
    background-color: var(--background-color) !important;
    border-radius: 15px !important;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1) !important;
}
"""

demo = gr.ChatInterface(
    fn=create_chatbot().predict,
    title="üè† –Ø —É–º–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –ø–æ –¥–∏–∑–∞–π–Ω—É –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞",
    description="üí¨ –ó–∞–¥–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å, –∏ —è –ø–æ–º–æ–≥—É –≤–∞–º –ø–æ–¥–æ–±—Ä–∞—Ç—å —Ç–æ–≤–∞—Ä—ã –¥–ª—è –∏–Ω—Ç–µ—Ä—å–µ—Ä–∞ –∏ –æ—Ç–≤–µ—á—É –Ω–∞ –≤–∞—à–∏ –∑–∞–ø—Ä–æ—Å—ã –ø–æ –¥–∏–∑–∞–π–Ω—É.",
    examples=[
        "–ú–Ω–µ –Ω—É–∂–µ–Ω –¥–∏–≤–∞–Ω –≤ —Å—Ç–∏–ª–µ –º–∏–Ω–∏–º–∞–ª–∏–∑–º –¥–ª—è –≥–æ—Å—Ç–∏–Ω–æ–π",
        "–ü–æ—Å–æ–≤–µ—Ç—É–π —Å–≤–µ—Ç–∏–ª—å–Ω–∏–∫ –¥–ª—è —Å–ø–∞–ª—å–Ω–∏ –≤ —Å–∫–∞–Ω–¥–∏–Ω–∞–≤—Å–∫–æ–º —Å—Ç–∏–ª–µ",
        "–ö–∞–∫–∏–µ –µ—Å—Ç—å –≤–∞—Ä–∏–∞–Ω—Ç—ã –æ–±–µ–¥–µ–Ω–Ω–æ–≥–æ —Å—Ç–æ–ª–∞ –¥–æ 30000 —Ä—É–±–ª–µ–π?"
    ],
    css=custom_css
)

if __name__ == "__main__":
    demo.launch(share=True)
